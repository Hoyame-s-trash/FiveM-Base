import{r as n,a as i,j as t}from"./jsx-runtime-7cf68bf7.js";import{u as L,f as p,H as X,q as F,L as o,ah as w,o as y,a6 as _,C as R,Y as V,r as W,Z as $,b,N as j,aw as q}from"./Phone-f429e90b.js";function B(){const c=L(b.PhoneNumber),[T,M]=n.useState(!1),[u,f]=n.useState([]),[g,N]=n.useState(!1),[a,s]=n.useState({title:"",description:"",attachments:[]}),[S,k]=n.useState(0),[d,v]=n.useState(!1),[r,m]=n.useState(!1),[h,E]=n.useState(""),[A,D]=n.useState(""),[I,K]=n.useState([]);n.useEffect(()=>{const e=setTimeout(()=>E(A),500);return()=>clearTimeout(e)},[A]),n.useEffect(()=>{h.length>0&&p("MarketPlace",{action:"search",query:h}).then(e=>{e&&K(e)})},[h]),n.useEffect(()=>{p("MarketPlace",{action:"getPosts",page:0}).then(e=>{e&&e.length>0?f(e):v(!0)}),p("isAdmin").then(e=>M(e))},[]);const O=()=>{if(!a.title||!a.description||!a.price||a.attachments===0)return;let e={...a,number:c};p("MarketPlace",{action:"sendPost",data:e}).then(l=>{l&&(f([{...e,id:l,timestamp:Date.now()},...u]),N(!1))})},U=e=>{e&&R.PopUp.set({title:o("APPS.MARKETPLACE.DELETE_POPUP.TITLE"),description:o("APPS.MARKETPLACE.DELETE_POPUP.TEXT"),buttons:[{title:o("APPS.MARKETPLACE.DELETE_POPUP.CANCEL")},{title:o("APPS.MARKETPLACE.DELETE_POPUP.PROCEED"),color:"red",cb:()=>{p("MarketPlace",{action:"deletePost",id:e}).then(l=>{l&&f(u.filter(C=>C.id!==e))})}}]})},x=e=>{if(d||r)return;let l=document.querySelector("#last");if(!l)return;!V(l)&&(m(!0),p("MarketPlace",{action:"getPosts",page:S+1}).then(P=>{P&&P.length>0?(f([...u,...P]),m(!1),P.length<15&&v(!0)):v(!0)}),k(P=>P+1))};return X("marketPlace:newPost",e=>{settings.airplaneMode||f([e,...u])}),n.useEffect(()=>{s({attachments:[]})},[g]),i("div",{className:"marketplace-container",children:[t("div",{className:"marketplace-header",children:t(F,{theme:"dark",placeholder:o("APPS.MARKETPLACE.SEARCH"),onChange:e=>D(e.target.value)})}),t("div",{className:"add",onClick:()=>N(!0),children:t(w,{})}),t("div",{className:"marketplace-wrapper",children:t("div",{className:"posts",onScroll:x,children:(h.length>0?I:u).map((e,l)=>{let C=l===u.length-1?"last":"";return t(H,{post:e,last:C,deletePost:U,isAdmin:T},l)})})}),g&&i("div",{className:"new-post-container",children:[i("div",{className:"new-post-header",children:[t("div",{className:"cancel",onClick:()=>N(!1),children:o("APPS.MARKETPLACE.CANCEL")}),t("div",{className:"title",children:o("APPS.MARKETPLACE.NEW_POST")}),t("div",{})]}),i("div",{className:"new-post-body",children:[i("div",{className:"item",children:[t("div",{className:"title",children:o("APPS.MARKETPLACE.TITLE")}),t(y,{type:"text",placeholder:"Title",maxLength:50,onChange:e=>s({...a,title:e.target.value})})]}),i("div",{className:"item",children:[t("div",{className:"title",children:o("APPS.MARKETPLACE.DESCRIPTION")}),t(_,{type:"text",placeholder:"Your post",maxLength:250,rows:5,onChange:e=>s({...a,description:e.target.value})})]}),t("div",{className:"item",children:i("div",{className:"images",children:[a.attachments&&a.attachments.length>0&&a.attachments.map((e,l)=>t("div",{className:"image",style:{backgroundImage:`url(${e})`},onClick:()=>{s({...a,attachments:a.attachments.filter((C,P)=>P!==l)})}},l)),a.attachments&&a.attachments.length<=3&&t("div",{className:"image",onClick:()=>{R.Gallery.set({onSelect:e=>s({...a,attachments:[...a.attachments??[],e.src]})})},children:t(w,{})})]})}),i("div",{className:"item",children:[t("div",{className:"title",children:o("APPS.MARKETPLACE.PRICE")}),t(y,{type:"number",placeholder:"0",onChange:e=>{if(!e.target.value.match(/^[0-9]*$/))return e.preventDefault();s({...a,price:e.target.value})}})]}),t("div",{className:"button",onClick:()=>O(),children:o("APPS.MARKETPLACE.POST")})]})]})]})}const H=({post:c,last:T,deletePost:M,isAdmin:u})=>{const f=L(b.Settings),g=L(b.PhoneNumber),N=L(j),a=n.useRef(null),s=n.useRef(null),[S,k]=n.useState(0),d={onMouseDown:r=>{d.pos={startLeft:s.current.scrollLeft,startX:r.clientX},s.current.style.userSelect="none",document.addEventListener("mouseup",d.onMouseUp),document.addEventListener("mousemove",d.onMove)},onMove:r=>{const m=(r.clientX-d.pos.startX)/q(f.display.size);s.current.scrollLeft=d.pos.startLeft-m;const h=s.current.getBoundingClientRect();(h.left-5>r.clientX||r.clientX>h.right-5)&&d.onMouseUp()},onMouseUp:r=>{s.current.style.removeProperty("user-select"),document.removeEventListener("mouseup",d.onMouseUp),document.removeEventListener("mousemove",d.onMove);const m=c.attachments,h=s.current.clientWidth;let E=S;const A=s.current.scrollLeft-d.pos.startLeft;A>h/2&&E<m.length-1?E++:A<-h/2&&E>0&&E--,v(E)}},v=r=>{s.current.scrollTo({left:r*s.current.offsetWidth,behavior:"smooth"}),k(r)};return i("div",{className:"post",id:T,ref:a,children:[t("div",{className:"images",ref:s,onMouseDown:d.onMouseDown,children:c.attachments&&c.attachments.map((r,m)=>t("div",{className:"image",children:t("img",{src:r,onClick:()=>R.FullscreenImage.set(r)})},m))}),i("div",{className:"post-info",children:[i("div",{className:"post-header",children:[t("div",{className:"price",children:N.CurrencyFormat.replace("%s",c.price)}),c.attachments&&c.attachments.length>1&&t("div",{className:"scroll-dots",children:c.attachments.map((r,m)=>t("div",{className:`dot ${S==m&&"active"}`,onClick:()=>v(m)},m))})]}),i("div",{className:"post-content",children:[i("div",{className:"title",children:[c.title,i("div",{className:"date",children:["â€¢ ",W(c.timestamp)]})]}),t("div",{className:"description",children:$(c.description)}),i("div",{className:"buttons",children:[g!==c.number&&t("div",{className:"button",onClick:()=>{window.postMessage({data:{number:c.number,popUp:!0},action:"phone:contact"})},children:o("APPS.MARKETPLACE.CONTACT")}),(u||c.number===g)&&t("div",{className:"button red",onClick:()=>M(c.id),children:o("APPS.MARKETPLACE.REMOVE")})]})]})]})]})};export{B as default};
