import{r as a,a as l,j as n,F as O}from"./jsx-runtime-bb820e81.js";import{u as N,h,f as P,L as r,ah as F,C as w,by as j,K as q,M as W,b as K,H as X,bw as $,bz as z,Z as B,a0 as y,o as J,bx as Y,Y as Z}from"./Phone-a7ab6193.js";function G(){const{Username:f,View:u,Channel:v}=a.useContext(k),[S,c]=v,[T,p]=u,[D]=f,[R,d]=a.useState(""),C=N(K.Settings),m=N(h.APPS.DARKCHAT.channels);return a.useEffect(()=>{h.APPS.DARKCHAT.channels.value||P("DarkChat",{action:"getChannels"}).then(t=>{t&&h.APPS.DARKCHAT.channels.set(t)})},[]),l("div",{className:"animation-slide right",children:[l("div",{className:"darkchat-header",children:[n("div",{className:"title",children:r("APPS.DARKCHAT.TITLE")}),n(F,{onClick:()=>{D&&w.PopUp.set({title:r("APPS.DARKCHAT.NEW_ROOM"),description:r("APPS.DARKCHAT.NEW_ROOM_TEXT"),input:{placeholder:r("APPS.DARKCHAT.ROOM_CODE"),type:"password",minCharacters:3,onChange:t=>d(t)},buttons:[{title:r("APPS.DARKCHAT.CANCEL")},{title:r("APPS.DARKCHAT.JOIN"),cb:()=>{d(t=>(P("DarkChat",{action:"joinChannel",name:t}).then(s=>{s&&(c({name:t}),p("chat"),h.APPS.DARKCHAT.channels.set([s,...m]))}),t))}}]})}})]}),n("div",{className:"channels-body",children:m==null?void 0:m.map((t,s)=>l("div",{className:"channel",onClick:()=>{D&&(c(t),p("chat"))},children:[l("div",{className:"channel-info",children:[l("div",{className:"channel-name",children:["#",C.streamerMode?"*****":t.name]}),l("div",{className:"recent-message",children:[l("div",{className:"members",children:[n(j,{}),l("span",{children:[t.members,":"]})]}),t.lastMessage]})]}),l("div",{className:"right",children:[n("div",{className:"timestamp",children:q(t.timestamp)}),n(W,{})]})]},s))})]})}function Q(){const{Username:f,View:u,Channel:v}=a.useContext(k),S=N(K.Settings),[c,T]=v,[p]=f,[D,R]=u,d=a.useRef(""),[C,m]=a.useState(""),[t,s]=a.useState([]),[g,V]=a.useState(0),[L,E]=a.useState(!1),[_,M]=a.useState(!1);a.useEffect(()=>{P("DarkChat",{action:"getMessages",page:0,channel:c.name}).then(e=>{e&&e.length>0?(s(e.reverse()),e.length<15&&E(!0)):E(!0)})},[]);const x=e=>{if(L||_)return;let i=document.querySelector("#last");if(!i)return;!Z(i)&&(M(!0),P("DarkChat",{action:"getMessages",page:g+1,channel:c.name}).then(o=>{o&&o.length>0?(s([...o.reverse(),...t]),M(!1)):E(!0)}),V(o=>o+1))};a.useEffect(()=>{let e=document.querySelector(".chat-wrapper");e.scrollTop=e.scrollHeight},[t]);const b=()=>{if(C.length>0){let e={sender:p,content:C,timestamp:new Date};P("DarkChat",{action:"sendMessage",content:C,channel:c.name}).then(i=>{m(""),d.current.value="",s(o=>[...o,e]);let A=h.APPS.DARKCHAT.channels.value.map(o=>(o.name===c.name&&(o.lastMessage=e.content,o.timestamp=new Date),o));h.APPS.DARKCHAT.channels.set(A)})}};return X("darkChat:newMessage",e=>{if(c.name!==e.channel)return;let i=h.APPS.DARKCHAT.channels.value.map(A=>(A.name===e.channel&&(A.lastMessage=e.content,A.timestamp=new Date),A));h.APPS.DARKCHAT.channels.set(i),s([...t,{...e,timestamp:new Date}])}),l("div",{className:"animation-slide left",children:[l("div",{className:"darkchat-header chat",children:[n($,{onClick:()=>{R("channels"),T(null)}}),l("div",{className:"title",children:["#",S.streamerMode?"*****":c.name]}),n(z,{onClick:()=>{w.PopUp.set({title:r("APPS.DARKCHAT.LEAVE_ROOM"),description:r("APPS.DARKCHAT.LEAVE_ROOM_TEXT"),buttons:[{title:r("APPS.DARKCHAT.CANCEL")},{title:r("APPS.DARKCHAT.LEAVE"),color:"red",cb:()=>{P("DarkChat",{action:"leaveChannel",channel:c.name}).then(e=>{if(e){R("channels"),T(null);let i=h.APPS.DARKCHAT.channels.value.filter(A=>A.name!==c.name);h.APPS.DARKCHAT.channels.set(i)}})}}]})}})]}),n("div",{className:"chat-wrapper",onScroll:x,children:n("div",{className:"chat-body",children:t.map((e,i)=>{var I;let A,o=i===0?"last":"",H=e.sender===p?"self":"other",U=((I=t[i+1])==null?void 0:I.sender)===p?"self":"other";return t[i+1]?A=Math.abs(e.timestamp-t[i+1].timestamp)/36e5:U=void 0,l("div",{className:`message ${H}`,id:o,children:[H=="other"&&n("div",{className:"user",children:e.sender}),n("div",{className:"content",children:B(e.content)}),t[i+1]&&A>6?n("div",{className:"date",children:y(e.timestamp,S.time.twelveHourClock)}):H!==U&&n("div",{className:"date",children:y(e.timestamp,S.time.twelveHourClock)})]},i)})})}),l("div",{className:"chat-bottom",children:[n(J,{type:"text",placeholder:r("APPS.DARKCHAT.INPUT_PLACEHOLDER"),value:C,ref:d,onChange:e=>{m(e.target.value)},onKeyDown:e=>{if(e.key==="Enter")return b()}}),n(Y,{onClick:()=>b()})]})]})}const k=a.createContext(null);function ne(){const[f,u]=a.useState(null),[v,S]=a.useState(null),[c,T]=a.useState("channels"),[p,D]=a.useState(""),[R,d]=a.useState(!1),[C,m]=a.useState(!0);a.useEffect(()=>{if(h.APPS.DARKCHAT.username.value){u(h.APPS.DARKCHAT.username.value),m(!1);return}P("DarkChat",{action:"getUsername"}).then(s=>{m(!1),s&&(u(s),h.APPS.DARKCHAT.username.set(s))})},[]);const t={channels:n(G,{}),chat:n(Q,{})};return n("div",{className:"darkchat-container",children:n(k.Provider,{value:{Username:[f,u],View:[c,T],Channel:[v,S]},children:!C&&l(O,{children:[!f&&!R&&l(O,{children:[d(!0),w.PopUp.set({title:r("APPS.DARKCHAT.USERNAME"),description:r("APPS.DARKCHAT.SET_USERNAME"),input:{placeholder:r("APPS.DARKCHAT.USERNAME"),type:"text",minCharacters:3,onChange:s=>D(s)},buttons:[{title:r("APPS.DARKCHAT.CANCEL"),cb:()=>K.App.reset()},{title:r("APPS.DARKCHAT.SET"),cb:()=>{D(s=>(P("DarkChat",{action:"setUsername",username:s}).then(g=>{if(!g)return d(!1);u(s)}),s))}}]})]}),t[c]]})})})}export{k as DarkChatContext,ne as default};
